var Re=Object.defineProperty,ke=Object.defineProperties;var De=Object.getOwnPropertyDescriptors;var me=Object.getOwnPropertySymbols;var Le=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable;var he=(s,t,e)=>t in s?Re(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,v=(s,t)=>{for(var e in t||(t={}))Le.call(t,e)&&he(s,e,t[e]);if(me)for(var e of me(t))Pe.call(t,e)&&he(s,e,t[e]);return s},j=(s,t)=>ke(s,De(t));import{PCFSoftShadowMap as xt,sRGBEncoding as Tt,WebGLRenderer as Mt}from"https://esm.sh/three@0.150.0";import{EffectComposer as Ee,RenderPass as vt}from"https://esm.sh/postprocessing@6.30.1";import{Vector2 as Be}from"https://esm.sh/three@0.150.0";var m=class{constructor(t){this.type=t}};var C=class extends m{constructor(e){super("boxCollider");this.width=(e==null?void 0:e.width)||32,this.height=(e==null?void 0:e.height)||32,this.mass=(e==null?void 0:e.mass)||5,this.offset=e&&e.offset||new Be,this.pivot=e==null?"BOTTOM_CENTER":e.pivot,this.isStatic=e==null?!1:e.isStatic,this.isTrigger=e&&e.isTrigger||!1,this.fixedRotation=e&&e.fixedRotation||!1,this.mesh=e&&e.mesh||!0}_clone(){return new C({width:this.width,height:this.height,mass:this.mass,mesh:this.mesh,offset:this.offset,pivot:this.pivot,isStatic:this.isStatic,isTrigger:this.isTrigger,fixedRotation:this.fixedRotation})}};import{Vector2 as Lt}from"https://esm.sh/three@0.150.0";import{Color as Ne}from"https://esm.sh/three@0.150.0";var E=class extends m{constructor(e){super("camera");this.lookAtSet=!1;this.context=(e==null?void 0:e.context)||"3d",this.active=(e==null?void 0:e.active)||!0,this.projection=(e==null?void 0:e.projection)||"perspective",this.fov=(e==null?void 0:e.fov)||45,this.near=(e==null?void 0:e.near)||1,this.far=(e==null?void 0:e.far)||1e4,this.factor=(e==null?void 0:e.factor)||100,this.background=(e==null?void 0:e.background)||new Ne(16777215),this.lookAt=e==null?void 0:e.lookAt}_clone(){return new E({active:this.active,projection:this.projection,fov:this.fov,near:this.near,far:this.far,lookAt:this.lookAt,background:this.background})}};import A from"https://esm.sh/lodash@4.17.21/cloneDeep";import*as jt from"https://esm.sh/three@0.150.0";var _=class extends m{constructor(e){super("interface");this.props=(e==null?void 0:e.props)||{},this.template=e.template,this.loaded=!1}_clone(){return new _({props:A(this.props),template:this.template})}};import{Color as qe}from"https://esm.sh/three@0.150.0";var I=class extends m{constructor(e){super("light");this.light=e.light,this.color=e.color||new qe(16777215),this.intensity=e.intensity||1}_clone(){return new I({light:this.light,color:this.color,intensity:this.intensity})}};var x=class extends m{constructor(e){super("mesh");this.model=e.model,this.castShadow=e.castShadow||!1,this.receiveShadow=e.receiveShadow||!1,this.visible=e.visible||!0,this.material=e.material||!1,this.fileType=e.fileType||"gltf",this.animation=e.animation||!1,this.shader=e.shader}_clone(){return new x({model:this.model,castShadow:this.castShadow,receiveShadow:this.receiveShadow,visible:this.visible,material:this.material,fileType:this.fileType,shader:this.shader,animation:this.animation})}};var R=class extends x{constructor(e){super(j(v({},e),{model:"PlaneMesh"}));this.width=e&&e.width||10,this.height=e&&e.height||10}_clone(){return new R({width:this.width,height:this.height,castShadow:this.castShadow,receiveShadow:this.receiveShadow,visible:this.visible,material:this.material,fileType:this.fileType,shader:this.shader})}};var k=class extends m{constructor(e){super("script");this.name=e.name}_clone(){return new k({name:this.name})}};import{Color as Oe}from"https://esm.sh/three@0.150.0";var T=class extends m{constructor(e){super("shape");this.shape=e&&e.shape||"rectangle",this.fill=e&&e.fill||new Oe(0),this.pivot=e&&e.pivot||"BOTTOM_CENTER"}_clone(){return new T({shape:this.shape,pivot:this.pivot,fill:this.fill})}};var D=class extends T{constructor(e){super(j(v({},e),{shape:"rectangle"}));this.width=e.width||32,this.height=e.height||32,this.radius=e.radius||2}_clone(){return new D({width:this.width,height:this.height,radius:this.radius,pivot:this.pivot,shape:this.shape})}};var L=class extends m{constructor(e){super("sprite");this.source=e==null?"enjin":e.source,this.width=e.width||32,this.height=e.height||32,this.pivot=e.pivot||"BOTTOM_CENTER",this.row=e.row||1,this.column=e.column||1,this.animation={active:!0,sequence:{name:"idle",currentFrame:0},sequences:{idle:[0],moveUp:[0,1,2,4,5],moveDown:[0,1,2,4,5]},tickCount:0,ticksPerFrame:7}}_clone(){return new L({source:this.source,width:this.width,height:this.height,pivot:this.pivot})}};var P=class extends m{constructor(e){super("tilemap");this.name=e&&e.name,this.infinite=e&&e.infinite||!0,this.rows=e&&e.rows||null,this.columns=e&&e.columns||null,this.layers=e&&e.layers}_clone(){return new P({name:this.name,infinite:this.infinite,rows:this.rows,columns:this.columns,layers:A(this.layers)})}};import{Vector3 as ne}from"https://esm.sh/three@0.150.0";var B=class extends m{constructor(e){super("transform");this.initialData=A(e),this.position=(e==null?void 0:e.position)==null?new ne:e.position,this.rotation=(e==null?void 0:e.rotation)==null?new ne:e.rotation,this.scale=(e==null?void 0:e.scale)==null?new ne(1,1,1):e.scale}_clone(){return new B({position:this.position,rotation:this.rotation,scale:this.scale})}};var oe=class{constructor(){this.events={add:[],update:[],remove:[]}}add(t,e){this.events[t].push(e)}getQuery(t,e){var i;if(!this.context.sceneManager.currentScene)throw console.log(this.context.sceneManager),new Error("[Query Manager]::No scene scene instantiated.");let o=(i=this.context.sceneManager.currentScene)==null?void 0:i.entitiesManager.getAllWithComponents(...e);return o==null?void 0:o.filter(n=>this.events[t].includes(n.id))}reset(){this.events.add=[],this.events.update=[],this.events.remove=[]}},g=new oe;var re=class{constructor(){this._scripts=new Map}async load(t){this._scripts=t.scripts}getConstructable(t){let e=this._scripts.get(t);if(e==null)throw new Error(`[ResourceLoader] could not find script "${t}"`);return e}},V=new re;var d=class{constructor(t){this.context=t}async start(t){}async run(t){}query(t){if(!this.queryComponents)throw new Error(`[AbstractSystem]::No query components defined for ${this}`);return g.getQuery(t,this.queryComponents)}};var K=class extends d{async run(){g.reset();let t=this.context.sceneManager.renderScenes;t.length!==0&&t.forEach(e=>{e.entitiesManager.getAllWithComponents("script").filter(i=>i.visible).forEach(i=>{i.components.get("script").forEach(r=>{if(r.instance==null){let a=V.getConstructable(r.name);r.instance=new a(this.context.sceneManager,i),console.log("Will add components to Script!",i.id,i.components);for(let[c,l]of[...i.components])c!=="script"&&(r.instance[c]=l);r.instance.start()}else r.instance!=null&&r.instance.update()})})})}};import{OrthographicCamera as fe,PerspectiveCamera as ue}from"https://esm.sh/three@0.150.0";import*as Fe from"https://esm.sh/three@0.150.0";import ze from"https://esm.sh/camera-controls@2.3.3";var X=class extends d{async start(t){ze.install({THREE:Fe})}async run(){let t=this.context.sceneManager.renderScenes;if(t.length===0)return;let e=this.getCameras(t),o=this.generateCameraPosition(e);e.forEach(({camera:i,transform:n,scene:r},a)=>{let{position:c}=n;i.instance||(i.instance=this.generateCamera(i),r.instance.add(i.instance),i.instance.position.x=c.x,i.instance.position.y=c.y,i.instance.position.z=c.z,i.effectComposer=this.context.postprocessing(r.instance,i.instance));let l=Math.floor(window.innerWidth*o[a].left),u=Math.floor(window.innerHeight*o[a].bottom),f=Math.floor(window.innerWidth*o[a].width),p=Math.floor(window.innerHeight*o[a].height);if(this.context.renderer.setViewport(l,u,f,p),this.context.renderer.setScissor(l,u,f,p),this.context.renderer.setScissorTest(!0),i.background&&(r.instance.background=i.background),i.instance instanceof fe&&(i.instance.left=f/-i.factor,i.instance.right=f/i.factor,i.instance.top=p/i.factor,i.instance.bottom=p/-i.factor),i.instance instanceof ue&&(i.instance.aspect=f/p),i.instance.updateProjectionMatrix(),i.lookAt&&!i.lookAtSet){let y=r.entitiesManager.getByName(i.lookAt),b=y==null?void 0:y.getComponent("sprite");b&&b.instance&&(console.log("ADDING TO PARENT"),b.instance.add(i.instance),i.instance.lookAt(b.instance.position),i.instance.position.x=c.x,i.instance.position.y=c.y,i.instance.position.z=c.z,i.lookAtSet=!0)}this.context.renderer.render(r.instance,i.instance)})}getCameras(t){let e=[];return t.forEach(o=>{let i=o.entitiesManager.getAllWithComponents("camera");e=[...e,...i.map(n=>({camera:n.components.get("camera"),transform:n.components.get("transform"),scene:o}))]}),e}generateCamera({projection:t,fov:e,near:o,far:i}){let{clientWidth:n,clientHeight:r}=document.body;switch(t){case"perspective":return new ue(e,n/r,o,i);case"orthographic":return new fe(n/-2,n/2,r/2,r/-2,o,i)}}generateCameraPosition(t){let o=[];for(let n=0;n<t.length;n+=2)o.push([...t.slice(n,n+2)]);let i=[];for(let n=0;n<o.length;n++)for(let r=0;r<o[n].length;r++)i.push({width:0+1/o[n].length,height:0+1/o.length,left:r===0?0:0+1/(r+1),bottom:n===0?0:0+1/(n+1)});return i}};import{Mesh as He,MeshBasicMaterial as We,Shape as Ge,ShapeGeometry as je}from"https://esm.sh/three@0.150.0";var Y=class extends d{async start(t){console.log("Shape System Starting!"),this.queryComponents=["shape","transform"]}async run(){let t=this.context.sceneManager.renderScenes;t.length!==0&&t.forEach(e=>{this.query("add").filter(o=>o.visible).forEach(o=>{var c;let i=o.components.get("shape"),{position:{x:n,y:r,z:a}}=o.components.get("transform");if(!i.instance){if(i.shape==="rectangle"){let{width:l,height:u,radius:f,pivot:p}=i;i.instance=this.generateRectangle({width:l,height:u,radius:f})}e.instance.add(i.instance)}i.instance&&((c=i.instance)==null||c.position.set(n,r,a))}),this.query("update").filter(o=>o.visible).forEach(o=>{let i=o.components.get("shape"),{position:{x:n,y:r,z:a}}=o.components.get("transform");i.instance&&i.instance.position.set(n,r,a)})})}generateRectangle({x:t=0,y:e=0,radius:o,width:i,height:n}){let r=o,a=new Ge().moveTo(t,e+r).lineTo(t,e+n-r).quadraticCurveTo(t,e+n,t+r,e+n).lineTo(t+i-r,e+n).quadraticCurveTo(t+i,e+n,t+i,e+n-r).lineTo(t+i,e+r).quadraticCurveTo(t+i,e,t+i-r,e).lineTo(t+r,e).quadraticCurveTo(t,e,t,e+r),c=new je(a);return new He(c,new We({color:0}))}};import{LinearFilter as Qe,NearestFilter as Ue,RepeatWrapping as ge,Sprite as Ze,SpriteMaterial as Je,Vector2 as et}from"https://esm.sh/three@0.150.0";import{TextureLoader as Ve}from"https://esm.sh/three@0.150.0";import{OBJLoader as Ke}from"https://esm.sh/three@0.150.0/examples/jsm/loaders/OBJLoader.js";import{MTLLoader as Xe}from"https://esm.sh/three@0.150.0/examples/jsm/loaders/MTLLoader.js";import{GLTFLoader as Ye}from"https://esm.sh/three@0.150.0/examples/jsm/loaders/GLTFLoader.js";import{FBXLoader as $e}from"https://esm.sh/three@0.150.0/examples/jsm/loaders/FBXLoader.js";var de=["PlaneMesh","BoxMesh"],se=class{constructor(){this._state="completed";this._resourcesSource={models:new Map,images:new Map,videos:new Map,shaders:new Map,fonts:[]};this._resources={models:new Map,images:new Map,videos:new Map,shaders:new Map,fonts:[]};this._textureLoader=new Ve;this._objLoader=new Ke;this._mtlLoader=new Xe;this._fbxLoader=new $e;this._gltfLoader=new Ye}get state(){return this._state}get resources(){return this._resources}addResources(t){console.log("[Resources Loader]",t),this._resourcesSource=t,console.log("[Resources Loaded]",t)}async getImage(t){return await this._textureLoader.loadAsync(`./resources/images/${this._resourcesSource.images.get(t)}`)}async load(t){this._state="loading";for(let e of t){let o=e.entitiesManager.getAllWithOneOfComponents("sprite","mesh");for(let i of o){let n=i.components.get("sprite"),r=i.components.get("mesh");if(n&&n.source&&!(n.source in this._resources.images)&&this._resources.images.set(n.source,await this._textureLoader.loadAsync(`./resources/images/${this._resourcesSource.images.get(n.source)}`)),r&&r.model&&!(r.model in this._resources.models)&&(console.log("HMM",de),!de.includes(r.model)))switch(console.log("Will try load:",r.model),r.fileType){case"obj":await this.loadObj(r);break;case"fbx":await this.loadFbx(r);break;case"gltf":case"glb":await this.loadGlb(r);break}r&&r.shader&&this._resources.shaders.set(r.shader,this._resourcesSource.shaders.get(r.shader))}}this._state="completed"}loadResourceModels(t,e){return new Promise((o,i)=>{})}async loadObj(t){let e=await this._mtlLoader.loadAsync(`./resources/models/${this._resourcesSource.models.get(t.model)}.mtl`);this._objLoader.setMaterials(e),this._resources.models.set(t.model,await this._objLoader.loadAsync(`./resources/models/${this._resourcesSource.models.get(t.model)}.obj`))}async loadFbx(t){let e=await this._fbxLoader.loadAsync(`./resources/models/${this._resourcesSource.models.get(t.model)}.fbx`);e.scale.multiplyScalar(.05),this._resources.models.set(t.model,e)}async loadGlb(t){console.log(t.model),console.log(this._resourcesSource.models);let e=await this._gltfLoader.loadAsync(`./resources/models/${this._resourcesSource.models.get(t.model)}.${t.fileType}`);this._resources.models.set(t.model,e)}},S=new se;var $=class extends d{async start(t){this.queryComponents=["sprite","transform"]}async run(){let t=this.context.sceneManager.renderScenes;t.length!==0&&t.forEach(e=>{this.query("add").filter(i=>i.visible).forEach(i=>{var u;let n=i.components.get("sprite"),r=i.components.get("transform"),{position:{x:a,y:c,z:l}}=r;if(n.instance==null){console.log("Creating Sprite",i,r),n.spriteMap=S.resources.images.get(n.source);let{width:f,height:p}=n,y=n.spriteMap.source.data.width/f,b=n.spriteMap.source.data.height/p;n.spriteMap.repeat.set(1/y,1/b),n.spriteMap.center=new et(0,1),n.spriteMap.offset.x=0/y,n.spriteMap.offset.y=0/b,n.spriteMap.minFilter=Qe,n.spriteMap.magFilter=Ue,n.spriteMap.wrapS=ge,n.spriteMap.wrapT=ge,n.spriteMaterial=new Je({map:n.spriteMap,depthWrite:!1}),n.instance=new Ze(n.spriteMaterial),n.instance.scale.set(this.getScaled(f),this.getScaled(p),1),e.instance.add(n.instance)}(u=n.instance)==null||u.position.set(a,c,l)}),this.query("update").filter(i=>i.visible).forEach(i=>{var l;console.log("Update Entity");let n=i.components.get("sprite"),{position:{x:r,y:a,z:c}}=i.components.get("transform");(l=n.instance)==null||l.position.set(r,a,c)}),e.entitiesManager.getAllWithComponents(...this.queryComponents).forEach(i=>{var l;let n=i.components.get("sprite"),{position:{x:r,y:a,z:c}}=i.components.get("transform");if(n.instance&&n.animation.active){(l=n.instance)==null||l.position.set(r,a,c);let{active:u,sequences:f,sequence:p,ticksPerFrame:y}=n.animation;if(u){n.animation.tickCount+=1,n.animation.tickCount>y&&(n.animation.tickCount=0,f[p.name].length-1<=p.currentFrame?n.animation.sequence.currentFrame=0:n.animation.sequence.currentFrame+=1);let{width:b,height:w}=n,q=n.spriteMap.source.data.width/b,ie=n.spriteMap.source.data.height/w,_e=Object.entries(f).findIndex(([Ie,Ct])=>Ie===p.name);n.spriteMap.offset.x=p.currentFrame/q,n.spriteMap.offset.y=_e/ie}}})})}getScaled(t){return t*1/this.context.scaleFactor}};import{Euler as ye,MathUtils as Q,Mesh as tt,PlaneGeometry as it,MeshBasicMaterial as nt,DoubleSide as ot,ShaderMaterial as rt}from"https://esm.sh/three@0.150.0";function st(s){console.log("Get Shader",s),console.log("Shader",S.resources);let t=S.resources.shaders.get(s);return console.log(t),new rt(t)}function at(s){switch(s.model){case"PlaneMesh":let t=new it(s.width,s.height,40),e=s.shader?st(s.shader):new nt({color:0,side:ot});return new tt(t,e);default:let o=S.resources.models.get(s.model);return o.scene?o.scene:o}}var U=class extends d{async start(t){this.queryComponents=["mesh","transform"]}async run(){let t=this.context.sceneManager.renderScenes;t.length!==0&&t.forEach(e=>{this.query("add").filter(o=>o.visible).forEach(o=>{var l,u;let i=o.components.get("mesh"),{position:{x:n,y:r,z:a},rotation:c}=o.components.get("transform");i.instance||(i.instance=at(i),e.instance.add(i.instance)),i.instance&&((l=i.instance)==null||l.position.set(n,r,a),(u=i.instance)==null||u.setRotationFromEuler(new ye(Q.degToRad(c.x),c.y*Math.PI/180,Q.degToRad(c.z),"XYZ")))}),this.query("update").filter(o=>o.visible).forEach(o=>{var l,u,f,p;let i=o.components.get("mesh"),{position:{x:n,y:r,z:a},rotation:c}=o.components.get("transform");i.instance&&(console.log("POSITION",i.instance),((l=i.instance)==null?void 0:l.type)==="Mesh"?(u=i.instance)==null||u.position.set(n,r,a):(f=i.instance)==null||f.children[0].position.set(n,r,a),(p=i.instance)==null||p.setRotationFromEuler(new ye(Q.degToRad(c.x),c.y*Math.PI/180,Q.degToRad(c.z),"XYZ")))})})}};import{AmbientLight as ct,DirectionalLight as pt,HemisphereLight as lt,PointLight as be}from"https://esm.sh/three@0.150.0";var Z=class extends d{async start(t){this.queryComponents=["transform","light"]}async run(){let t=this.context.sceneManager.renderScenes;t.length!==0&&t.forEach(e=>{this.query("add").filter(o=>o.visible).forEach(o=>{var c;let i=o.components.get("light"),{position:{x:n,y:r,z:a}}=o.components.get("transform");if(!i.instance){switch(i.light){case"point":i.instance=new be(16777215,1,500);break;case"directional":i.instance=new pt(16777215),i.instance.color.setHSL(.1,1,.95),i.instance.position.multiplyScalar(30);break;case"hemisphere":i.instance=new lt(16777215,16777215,.6),i.instance.color.setHSL(.6,1,.6),i.instance.groundColor.setHSL(.095,1,.75);break;case"ambient":i.instance=new ct(16777215);break;case"spot":i.instance=new be(16777215),i.instance.shadow.mapSize.width=1024,i.instance.shadow.mapSize.height=1024;break;default:break}e.instance.add(i.instance)}i.instance&&((c=i.instance)==null||c.position.set(n,r,a))})})}};import{AnimationMixer as mt,Clock as ht}from"https://esm.sh/three@0.150.0";var J=class extends d{constructor(){super(...arguments);this.clock=new ht}async start(e){this.queryComponents=["mesh"]}async run(){let e=this.context.sceneManager.renderScenes;e.length!==0&&e.forEach(o=>{this.query("add").filter(i=>i.visible).forEach(i=>{let n=i.components.get("mesh");console.log("FBX.ANIMAITON",n),!n.mixer&&n.instance&&n.animation&&(n.mixer=new mt(n.instance),console.log("FBX.ANIMAITON",n.mixer),n.mixer.clipAction(n.instance.animations[4]).play())}),o.entitiesManager.getAllWithComponents("mesh").filter(i=>i.visible).forEach(i=>{let n=i.components.get("mesh");n.mixer&&n.mixer.update(this.clock.getDelta())})})}};import{Quaternion as we,MathUtils as M,LineBasicMaterial as dt,BufferGeometry as gt,LineSegments as yt}from"https://esm.sh/three@0.150.0";import{Vector3 as ft}from"https://esm.sh/three@0.150.0";import{SimplifyModifier as oo}from"https://esm.sh/three@0.150.0/examples/jsm/modifiers/SimplifyModifier.js";import{mergeVertices as so}from"https://esm.sh/three@0.150.0/examples/jsm/utils/BufferGeometryUtils.js";function ut(s){if(console.log("Mesh",s),s.isMesh)return s;for(let t of s.children)if(t.type==="Mesh")return t}function Se(s){let t=ut(s);if(console.log("FOUND:",t),!t)throw Error("No Mesh");let e=t.geometry.getAttribute("position"),o=[],i=[];for(let n=0;n<e.count;n++){let r=new ft;r.fromBufferAttribute(e,n),i.push(n),o.push(r.x,r.y,r.z)}return{vertices:o,indices:i}}import N from"https://cdn.skypack.dev/@dimforge/rapier3d-compat";var ee=class extends d{async start(e){await N.init();let o=this.context.sceneManager.renderScenes;console.log("PHYSICS SYSTEMS"),this.world=new N.World({x:0,y:-9.81,z:0});let i=N.ColliderDesc.cuboid(10,.1,10);this.world.createCollider(i),o.forEach(n=>{let r=new dt({color:16777215,vertexColors:!0}),a=new gt;this.lines=new yt(a,r),n.addChild(this.lines)}),this.queryComponents=["boxCollider"]}async run(){let e=this.context.sceneManager.renderScenes;e.length!==0&&(e.forEach(o=>{this.query("add").filter(n=>n.visible).forEach(n=>{console.log("PHYSICS::ADD",n.name);let r=n.components.get("mesh"),a=n.components.get("sprite"),c=n.components.get("boxCollider");console.log("Mesh:",r),console.log("Sprite:",a);let{position:{x:l,y:u,z:f},rotation:p}=n.components.get("transform");if(!c.instance&&(r!=null&&r.instance)){let y=new we(0,0,0,0);M.setQuaternionFromProperEuler(y,M.degToRad(p.x),M.degToRad(p.y),M.degToRad(p.z),"XYX");let{vertices:b,indices:w}=Se(r.instance),q=N.ColliderDesc.trimesh(b,w).setTranslation(l,u,f).setRotation({w:y.w,x:y.x,y:y.y,z:y.z});c.instance=this.world.createCollider(q)}if(!c.instance&&(a!=null&&a.instance)){let{width:y,height:b}=a,w=new we(0,0,0,0);M.setQuaternionFromProperEuler(w,M.degToRad(p.x),M.degToRad(p.y),M.degToRad(p.z),"XYX");let q=N.RigidBodyDesc.dynamic().setTranslation(l,u,f).setRotation({w:w.w,x:w.x,y:w.y,z:w.z}).lockRotations();c.instance=this.world.createRigidBody(q);let ie=N.ColliderDesc.cuboid(this.getScaled(y),this.getScaled(b),.1);this.world.createCollider(ie,c.instance)}}),o.entitiesManager.getAllWithComponents(...this.queryComponents).forEach(n=>{let r=n.components.get("boxCollider"),a=n.components.get("transform");a.position=r.instance.translation()})}),this.world.step())}getScaled(e){return e*1/this.context.scaleFactor/2}};var xe={ShapeSystem:Y,SpriteSystem:$,MeshSystem:U,PhysicsSystem:ee,FbxAnimationSystem:J,CameraSystem:X,LightSystem:Z,ScriptSystem:K},Te=(s,t={})=>{var o,i;let e=v({},xe);return"include"in t?(e={},(o=t.include)==null||o.forEach(n=>{e[n]=xe[n]})):"exclude"in t&&((i=t.exclude)==null||i.forEach(n=>{delete e[n]})),new Map(Object.entries(e).map(([n,r])=>[n,new r(s)]))};var Me=[{type:"script",attributes:{src:"https://cdn.jsdelivr.net/npm/vue@2"}}],ve=function(s){for(let{type:t,attributes:e}of s){let o=document.createElement(t);Object.entries(e).forEach(([i,n])=>{o[i]=n}),document.head.appendChild(o)}};var O=class{constructor(){this.scenes=[];this._previousScene=null;this._currentScene=null;this.renderScenes=[]}get currentScene(){return this._currentScene}getScene(t){return this.scenes.find(e=>e.id===t)||null}add(t){this.scenes.push(t),this.scenes.sort((e,o)=>e.order>o.order?1:-1)}getSceneByName(t){return this.scenes.find(e=>e.name===t)}init(){console.log("[Scene Manager]::INITIALIZATION"),this._currentScene=this.scenes[0],this.renderScenes=[this._currentScene]}changeScene(t,e){var o,i;this._previousScene=this._currentScene,(o=this._previousScene)==null||o.unload(),this._currentScene=this.scenes.find(n=>n.name===t)||null,this.renderScenes=[this._currentScene],(i=this._currentScene)==null||i.load(e)}reset(){var t;(t=this._currentScene)==null||t.reset()}};import{GridHelper as bt,Scene as St,Vector3 as wt}from"https://esm.sh/three@0.150.0";var ae=class{constructor(){this._entities=new Map}addEntities(t){this._entities=t}instantiate(t){return this.getEntity(t)._clone()}getEntity(t){let e=this._entities.get(t);if(!e)throw new Error(`[EntitiesLoader] entity with name "${t}" doesn't exist`);return e._clone()}},F=new ae;var z=class{constructor(t){this._entities=new Map;this._entitiesNames=t,t.forEach(e=>{this.add(F.getEntity(e))})}getAll(){return Array.from(this._entities.values())}getAllWithComponents(...t){let e=[];for(let[,o]of this._entities)t.every(n=>o.components.has(n))&&e.push(o);return e}getAllWithOneOfComponents(...t){let e=[];for(let[,o]of this._entities)t.find(n=>o.components.has(n))&&e.push(o);return e}getByName(t){for(let[,e]of this._entities)if(e.name===t&&e.visible)return e}getByTag(t){let e=[];for(let[,o]of this._entities)o.name===t&&e.push(o);return e}getById(t){return this._entities.get(t)}getAllWithID(t){let e=[];for(let[,o]of this._entities)t.includes(o.id)&&e.push(o);return e}add(t){this._entities.set(t.id,t._clone()),g.add("add",t.id)}remove(t){this._entities.delete(t),g.add("remove",t)}reset(){g.reset(),this._entities=new Map,this._entitiesNames.forEach(t=>{let e=F.getEntity(t),o=e._clone();this._entities.set(e.id,o),g.add("add",e.id)})}};var Ce=1e3,te=()=>(Ce+=1,String(Ce));function H(s,t){for(let e in s)s.hasOwnProperty(e)&&typeof s[e]=="object"&&(s[e]=H(s[e],t));return new Proxy(s,t)}var W=class{constructor(t){this._cameras=[];this.childScenes=[];this.id=te(),this.instance=new St,this.initialData=t,console.log(t),this.entitiesManager=new z(t.entities),this.order=t.order,this.name=t.name,this.scripts=t.scripts,this.childScenes=t.childScenes}loadInterface(){let t=document.querySelector("#interfaces");if(!t)throw new Error("[SCENE]::Missing interfaces container.");return t.innerHTML="",t}init(){console.log("[SCENE] - INITIALIZATION",this.instance)}async load(t){console.log("[SCENE] - INITIALIZATION INTERFACE"),this.props=t,this.interface=this.loadInterface(),await S.load([this]),this.clean(),this.entitiesManager.reset();let e=new bt(100,10);this.instance.add(e)}unload(){this.clean(),this.interface&&(this.interface.innerHTML="")}clean(){for(console.log("RESET",this.instance.children);this.instance.children[0];)this.instance.remove(this.instance.children[0]);this._cameras=[]}addChild(t){this.instance.add(t)}instantiate(t,e){let o=t._clone(),i=o.components.get("transform");return i.position=e||i.position||new wt(0,0,0),this.entitiesManager.add(o),o}reset(){console.log("SCENE RESET"),this.unload(),this.load(),this.init()}};var ce=class{constructor({systems:t={},graphics:e}){this.composers=[];g.context=this,this.sceneManager=new O,this.renderer=this.setupRenderer(e),this.composer=new Ee(this.renderer),this._systems=Te(this,t),this.scaleFactor=e.scaleFactor||1}setupRenderer({antialias:t=!0,background:e=16777215,element:o}){console.log("[Axink]::INITIALIZE VIEWPORT");let i=new Mt({powerPreference:"high-performance",antialias:!1,stencil:!1});if(i.setClearColor(e,1),i.setPixelRatio(window.devicePixelRatio),i.outputEncoding=Tt,i.shadowMap.enabled=!0,i.shadowMap.type=xt,i.autoClear=!1,i.autoClearDepth=!1,i.sortObjects=!0,i.setSize(window.innerWidth,window.innerHeight),ve(Me),addEventListener("resize",()=>{i.clear(),i.setSize(innerWidth,innerHeight)}),document.body.style.margin="0",document.body.style.overflow="hidden",document.body.style.position="relative",document.body.style.width="100vw",document.body.style.height="100vh",o){let n=document.querySelector(o);n&&(console.log(n),i.setSize(n.clientWidth,n.clientHeight),n.appendChild(i.domElement),n.appendChild(this.loadInterface()))}else document.body.appendChild(i.domElement),document.body.appendChild(this.loadInterface());return i}loadInterface(){let t=document.createElement("div");return t.id="interfaces",t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t}async init(t){t.entities&&F.addEntities(t.entities),t.resources&&(console.log("Resources"),S.addResources(t.resources)),t.scripts&&await V.load({scripts:t.scripts,engine:this})}async start(t=!1){var e,o,i;console.log("[AXINK]::START"),this.sceneManager.init(),console.log("AFTER INIT:",(e=this.sceneManager.currentScene)==null?void 0:e.entitiesManager.getAll()),this.sceneManager.currentScene&&(await this.sceneManager.currentScene.load(),console.log("AFTER LOAD:",(o=this.sceneManager.currentScene)==null?void 0:o.entitiesManager.getAll()),await S.load(this.sceneManager.renderScenes)),console.log((i=this.sceneManager.currentScene)==null?void 0:i.entitiesManager.getAll()),console.log("[AXINK]::SYSTEMS(START)");for(let n of[...this._systems])await n[1].start();console.log("[AXINK]::LOOP(START)"),t&&this.loop()}postprocessing(t,e){let o=new Ee(this.renderer),i=new vt(t,e);return i.renderToScreen=!0,o.addPass(i),o}async loop(){for(let[,t]of this._systems)"run"in t&&await t.run();g.reset(),requestAnimationFrame(this.loop.bind(this))}addScene(t){console.log("[AXINK]::ADD SCENE"),this.sceneManager.add(new W(t))}};var G=class{constructor(t,e=""){this.components=new Map;this.id=te(),this.name=t,this.tag=e,this._visible=!0}addComponent(t){if(t.type==="script"){let e=this.components.has(t.type)?this.components.get(t.type):[];this.components.set(t.type,[...e,t])}else{g.add("add",this.id);let e=H(t,{set:(o,i,n)=>(g.add("update",this.id),o[i]=n,!0)});this.components.set(t.type,e)}return this}removeComponent(t){return this.components.delete(t),this}getScript(t){var o;return(o=this.components.get("script").find(i=>i.name===t))==null?void 0:o.instance}getComponent(t){let e=this.components.get(t);if(e==null)throw Error(`[Entity] This entity doesn\xB4t contain a ${t} component`);return e}get visible(){return this._visible}set visible(t){this._visible=t}_clone(){let t=new G(this.name);for(let[,e]of this.components)if(Array.isArray(e))e.forEach(o=>{if(o.type==="script")t.addComponent(o._clone());else{let i=H(o._clone(),{set:(n,r,a)=>(g.add("update",t.id),n[r]=a,!0)});t.addComponent(i)}});else{if(e.type!=="script"){let o=H(e._clone(),{set:(i,n,r)=>(g.add("update",t.id),i[n]=r,!0)});t.addComponent(o)}t.addComponent(e._clone())}return t}};var pe=class{constructor(){this._keys=new Map,this.init()}init(){document.addEventListener("keydown",t=>{let e=t.key;this._keys.has(e)||this._initKey(e);let o=this._keys.get(e);o.wasClicked=!o.isPressed,o.isPressed=!0,o.wasReleased=!1}),document.addEventListener("keyup",t=>{let e=this._keys.get(t.key);e.isPressed=!1,e.wasClicked=!1,e.wasReleased=!0})}getKeyDown(t){if(this._keys.has(t)){let e=this._keys.get(t),o=e.wasClicked;return e.wasClicked=!1,o}return!1}getKeyUp(t){if(this._keys.has(t)){let e=this._keys.get(t),o=e.wasReleased;return e.wasReleased=!1,o}return!1}getKeyPressed(t){if(this._keys.has(t)){let{isPressed:e}=this._keys.get(t);return e}return!1}_initKey(t){this._keys.set(t,{isPressed:!1,wasClicked:!1,wasReleased:!1})}},Ae=new pe;var le=class{constructor(t,e,o){this._sceneManager=t,this._entity=e,this._components=o,this._input=Ae}get name(){return this._name||"Unnamed Script"}get scene(){for(let t of this._sceneManager.renderScenes)if(t.entitiesManager.getById(this._entity.id))return t;return this._sceneManager.currentScene}get entity(){return this._entity}get sceneManager(){return this._sceneManager}get components(){return this._components}get input(){return this._input}changeScene(t,e){this._sceneManager.changeScene(t,e)}resetScene(){this._sceneManager.reset()}find(t){var o;let e=(o=this._sceneManager.currentScene)==null?void 0:o.entitiesManager.getByName(t);if(!e)throw new Error(`[SCRIPT] - Entity ${t} doesn't exist.`);return e}start(){}update(){}};import{Color as Rr,Vector2 as kr,Vector3 as Dr,BoxGeometry as Lr,RepeatWrapping as Pr,Clock as Br}from"https://esm.sh/three@0.150.0";export{le as AbstractScript,ce as Axink,C as BoxCollider,Lr as BoxGeometry,E as Camera,Br as Clock,Rr as Color,G as Entity,_ as Interface,I as Light,x as Mesh,R as PlaneMesh,D as Rectangle,Pr as RepeatWrapping,k as Script,T as Shape,L as Sprite,P as Tilemap,B as Transform,kr as Vector2,Dr as Vector3,S as resourcesLoader};
